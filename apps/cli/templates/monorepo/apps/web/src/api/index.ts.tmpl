import { API_URL } from "@/config/env";
import { apiContract } from "@{{PROJECT_NAME_KEBAB}}/openapi/contracts";
import {
  initClient,
  type ApiFetcherArgs,
  type ClientArgs,
} from "@ts-rest/core";
import { initTsrReactQuery } from "@ts-rest/react-query/v5";
import axios, {
  AxiosError,
  isAxiosError,
  type AxiosResponse,
  type Method,
} from "axios";

type Headers = Awaited<
  ReturnType<NonNullable<Parameters<typeof initClient>[1]["api"]>>
>["headers"];

export type TApiClient = ReturnType<typeof useApiClient>;

const createApiFetcher =
  ({ isBlob = false }: { isBlob?: boolean } = {}) =>
  async ({ path, method, headers, body, fetchOptions }: ApiFetcherArgs) => {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const makeRequest = async (retryCount = 0): Promise<any> => {
      try {
        const result = await axios.request({
          method: method as Method,
          url: path,
          headers: {
            ...headers,
          },
          data: body,
          signal: fetchOptions?.signal ?? undefined,
          withCredentials: true,
          ...(isBlob ? { responseType: "blob" } : {}),
        });
        return {
          status: result.status,
          body: result.data,
          headers: result.headers as unknown as Headers,
        };
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
      } catch (e: Error | AxiosError | any) {
        if (isAxiosError(e)) {
          const error = e as AxiosError;
          const response = error.response as AxiosResponse;

          const shouldRefresh =
            response?.status === 401 &&
            retryCount < 1 &&
            !path.includes("/api/v1/auth/refresh");
          if (shouldRefresh) {
            const refreshed = await attemptRefresh();
            if (refreshed) {
              return makeRequest(retryCount + 1);
            }
          }

          return {
            status: response?.status || 500,
            body: response?.data || { message: "Internal server error" },
            headers: (response?.headers as unknown as Headers) || {},
          };
        }
        throw e;
      }
    };

    return makeRequest();
  };

const attemptRefresh = async () => {
  try {
    await axios.post(
      `${API_URL}/api/v1/auth/refresh`,
      {},
      { withCredentials: true },
    );
    return true;
  } catch {
    return false;
  }
};

const createClientArgs = ({
  isBlob = false,
}: {
  isBlob?: boolean;
} = {}): ClientArgs => ({
  baseUrl: API_URL,
  baseHeaders: {
    "Content-Type": "application/json",
  },
  api: createApiFetcher({ isBlob }),
});

export const useApiClient = ({ isBlob = false }: { isBlob?: boolean } = {}) =>
  initClient(apiContract, createClientArgs({ isBlob }));

export const tsr = initTsrReactQuery(apiContract, createClientArgs());

export const __testing = { createApiFetcher, attemptRefresh };
